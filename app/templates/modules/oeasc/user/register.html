{%- extends "modules/oeasc/site/layout.html" %}


{%- block title %} inscription {%- endblock %}

{%- block content %}

<div class="row">

    <div class="col-md-12">

        <div class="container">

            <h2>Inscription</h2>

            <div class="alert alert-danger" role="alert" id="login-error" style="display: none;"></div>

            <div id="info_register" style="display: none;">

                <p>Votre demande d'inscription est bien prise en compte.</p>
                <p>Un e-mail de vérification a été envoyé.</p>
                <p>Veuillez cliquer sur le lien de confirmation présent dans cet e-mail afin de valider votre compte.</p>

            </div>

            {%- include "modules/oeasc/form/form_user.html" %}

        </div>

    </div>

</div>

{%- endblock %}


{%- block js_local %}

{{ super() }}

<script>

    $(document).ready(function() {

        "use scrict";

        var test = "{{config.MODE_TEST}}" == "1";
        var id_app = {{config.ID_APP}};
        var url_post = '{{config.URL_APPLICATION}}/pypn/register/post_usershub/create_temp_user'
        var url_mail = '{{config.URL_APPLICATION}}/api/mail/create_temp_user'

        $('#nom_organisme_div').hide();

        $('#user_organism').change(function() {

            var nom_organisme = $('#user_organism :selected').html();

            
            if (nom_organisme == "Autre (préciser)") {

                console.log(nom_organisme)
                $('#nom_organisme_div').show();
                $('#nom_organisme').val("");

            } else {

                $('#nom_organisme_div').hide();
                $('#nom_organisme').val(nom_organisme);

            }

        });


        if(test) {

            $('#user_nom').val("CLEMENT");
            $('#user_prenom').val("Joël");
            $("#user_email").val("joelclems@gmail.com");
            $('#user_pwd').val("1234");
            $('#user_pwd_conf').val("1234");
            var id_organisme = parseInt($("#user_organism option")[2].value);
            $('#user_organism').selectpicker('val', id_organisme);
            $('#user_organism').change()
            $('#desc_role').selectpicker('val', "Salarié ou agent");

        };

        $("#login-error").hide();

        var show_error = function(elem="", msg="") {

            console.log(elem)
            console.log($("#" + elem))
            $("#login-error").html(msg).show();
            $("#" + elem).parent().before($("#login-error"));
            $([document.documentElement, document.body]).animate({
                scrollTop: $("#login-error").offset().top - 100
            }, 300);

        };


        var register = function(e) {

            e.preventDefault();

            // gestion email
            var expressionReguliere = /^(([^<>()[]\.,;:s@]+(.[^<>()[]\.,;:s@]+)*)|(.+))@(([[0-9]{1,3}.[0-9]{1,3}.[0-9]{1,3}.[0-9]{1,3}])|(([a-zA-Z-0-9]+.)+[a-zA-Z]{2,}))$/;

            if(!expressionReguliere.test($('#user_email').val())) {

                show_error('user_email', "L'adresse email est invalide");
                return false;
            }

            // gestion mot de passe
            if( $('#user_pwd').val() != $('#user_pwd_conf').val()) {
                show_error('user_pwd', 'Les mots de passes ne correspondent pas.');
                return false;

            }

            // gestion identifiant (ici email) non unique et droits
            var user;
            // si on a déjà un utilisateur avec ce mail
            if( (user = M.get_db('user', 'email',$('#user_email').val())) != "None") {

                // et qu'il a déjà les droits pour cette application
                if(user.app_users.some(a => a.id_application == id_app)) {

                    show_error('user_email', 'Cette adresse email est déjà utilisé pour cette application. Veuillez vous rendre à la <a href="' + "{{url_for('user.login')}}" + '?identifiant=' + user.email + '">page de connexion</a> ou choisir une adresse mail différente.');
                    return false;

                } else {

                    show_error('user_email', 'Un compte existe déjà avec cette adresse mail, mais il ne possède pas encore les droits pour cette application. Pour activer ce compte sur cette application <a href="' + "{{url_for('user.login')}}" + '?type=add_droit&identifiant=' + user.email + '">cliquer ici</a>.');
                    return false;

                }

            }

            // gestion organisme non choisi
            if( $('#user_organism').val() == "" ) {

                show_error('user_organism', 'Choisir un organisme.');
                return false;

            }

            // gestion fonction non choisie
            if( $('#user_fonction').val() == "" ) {

                show_error("#user_fonction", "Choisir une fonction.")
                return false;

            }

            var data = {

                "nom_role": $('#user_nom').val(),
                "prenom_role": $('#user_prenom').val(),
                "identifiant": $('#user_email').val(),
                "email": $('#user_email').val(),

                "password": $('#user_pwd').val(),
                "password_confirmation": $('#user_pwd_conf').val(),

                "groupe": false,
                "pn": true,
                "remarques": "creé depuis le site OEASC",
                "id_unite": -1,
                "id_organisme": $('#user_organism').val(),
                "organisme": $('#nom_organisme').val().substr(0,32),
                "desc_role": $('#desc_role').val(),

            };

            $("#login-error").hide();

            console.log(url_post)

            $.post( {
                url : url_post,
                type: 'POST',
                data : JSON.stringify(data),
                contentType:"application/json; charset=utf-8",
                dataType:"json",
            }).done(function(response){
               console.log(response);
               $('#form_register').hide();
               $("#info_register").show();
           })
            .fail(function(error){

                console.log("error", error)
                show_error("button_register", "Erreur : " + error.responseText)
                console.log(error);

            });

        };


        $("#form_user").submit(register);

    });

</script>

{%- endblock %}
