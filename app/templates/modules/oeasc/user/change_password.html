{%- extends "modules/oeasc/site/layout.html" %}


{%- block title %}Login{%- endblock %}

{%- block content %}

<div class="row">

    <div class="col-md-12">

        <div class="container">

            <div id="erreur" style="display: none;" class=red></div>

            <h2>Changement du mot de passe</h2>

            <div class="alert alert-danger" role="alert" id="login-error" style="display: none;"></div>

            <div id="email_success" style="display: none;">

                <p>Un e-mail vous a été envoyé.</p>
                <p>Veuillez cliquer sur le lien de présent dans cet e-mail afin de pouvoir modifier votre mot de passe.</p>

            </div>

            <div id="password_success" style="display: none;">

                <p>Votre mot de passe a été modifié. Vous pouvez vous connecter sur la page de 
                    {# <a class="btn-info" href="{{url_for('user.login')}}"><u>connexion</u></a> #}
                    {% set href=url_for('user.login')%}
                    <button class='btn btn-info' onclick="location.href='{{href}}'">connexion</button>
                </p>

            </div>



            {%- if not token %}
            <form class="form-horizontal" id="form_identifiant">


                <div>
                    <div class="form">


                        <p>Entrez votre identifiant (e-mail utilisé pour la création du compte) et appuyez sur <b>modifier le mot de passe</b>.</p>
                        <div id="email">

                            <table class="table">
                                <tr>
                                    <th>
                                        E-mail :
                                    </th>
                                    <td>
                                        <input required type="text" class="form-control" id="form_email" value={{identifiant}}>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <button class="btn btn-success">Modifier le mot de passe</button>
                                    </td>
                                    <td></td>
                                </tr>
                            </table>
                        </div>

                    </div>
                </div>
            </form>

            {%- else %}
            <form class="form-horizontal" id="form_password">


                <div>
                    <div class="form">

                        <div id="pwds">
                            <table class="table">
                                <tr>
                                    <th>
                                        Mot de passe :
                                    </th>
                                    <td>
                                        <input type="password" class="form-control" id="user_pwd" required>
                                    </td>
                                </tr>
                                <tr>
                                    <th>
                                        Confirmation du mot de passe :
                                    </th>
                                    <td>
                                        <input type="password" class="form-control" id="user_pwd_conf" required>
                                    </td>
                                </tr>
                                <tr>
                                    <td>
                                        <button class="btn btn-success">Modifier le mot de passe</button>
                                    </td>
                                    <td></td>
                                </tr>
                            </table>

                            </div>
                        </div>


                    </form>
                    {%- endif %}

                </div>

            </div>

        </div>

        {%- endblock %}


        {%- block js_local %}

        {{ super() }}

        <script>

            $(document).ready(function() {

                "use scrict";

                if("{{config.MODE_TEST}}" == "1") {

                    $("#form_email").val('joelclems@gmail.com')
                    $("#user_pwd_conf").val('2345')
                    $("#user_pwd").val('2345')

                }

                $("#erreur").hide();

                $("#form_identifiant").submit(function(e) {

                    $("#erreur").hide();

                    e.preventDefault()

                    $.post({

                        url: '/pypn/register/post_usershub/create_cor_role_token',
                        data: JSON.stringify({
                            email: $('#form_email').val()
                        }),
                        contentType:"application/json; charset=utf-8",
                        dataType:"json",
                    }).done(function(response) {
                        console.log('success');
                        $('#form_identifiant').hide();
                        $('#email_success').show()
                    }).
                    fail(function(data) {
                        console.log("fail")
                        $('#erreur').html("erreur : " + data);
                        $('#erreur').show()

                    });
                    console.log("end");
                });

                $("#form_password").submit(function(e) {

                    $('#erreur').hide()

                    e.preventDefault()

                    if($('#user_pwd').val() != $('#user_pwd_conf').val()) {

                        $('#erreur').html("Les mot de passe renseignés ne sont pas identiques.");
                        $('#erreur').show()

                        return False;

                    }

                    $.post({

                        url: '/pypn/register/post_usershub/change_password',
                        data: JSON.stringify({
                            password: $('#user_pwd').val(),
                            password_confirmation: $('#user_pwd_conf').val(),
                            token: "{{token}}",
                        }),
                        contentType:"application/json; charset=utf-8",
                        dataType:"json",
                    }).done(function(response) {
                        console.log('done', response)
                        $('#form_password').hide();
                        $('#password_success').show()
                    }).fail(function(data) {
                        console.log('fail', data.responseText)
                        $('#erreur').html(data.responseText);
                        $('#erreur').show()
                    });
                })
            });



        </script>

        {%- endblock %}
