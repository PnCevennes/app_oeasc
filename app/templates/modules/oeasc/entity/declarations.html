{%- block declarations %}

{%- import "modules/oeasc/macros/macros_display.html" as macros_display %}

<div id="declarations">

  <h2>Liste de déclarations</h2>

  <div id="data_declarations">

    {%- for declaration in declarations %}
    <div class="data-declaration" data-declaration='{{ declaration | tojson if declaration else "" }}' style="display:none;"></div>
    {%- endfor %}

  </div>

  {% if session.current_user.id_droit_max > 5 %}
  <ul>
    <li>
      <a href="/api/declaration/declarations_csv">Export CSV une déclaration par ligne</a>
    </li>
    <li>
      <a href="/api/declaration/declarations_csv/degat">Export CSV un dégât par ligne</a>
    </li>
  </ul>
  {% endif %}

  <nav id="declarations_tabs" class="nav nav-tabs">
    <a class="nav-item nav-link" href="#resultats" data-toggle="tab" data-type="T">Tableau</a>
    <a class="nav-item nav-link" href="#resultats" data-toggle="tab" data-type="TC">Carte</a>
  </nav>

  <div class="tab-pane active" id="resultats">

    <div class="row">

      <div id='tableau_declarations' class="col-md-6">
       <table id="table_declarations" class="table-striped table-small">
        <thead>
          <tr>
            <th>Actions</th>
            <th>ID</th>
            <th>Déclarant</th>
            <th>Organisme</th>
            <th>Date</th>
            <th>Nom forêt</th>
            <th>Commune(s)</th>
            <th>Parcelles</th>
            <th>Ess. objectif</th>
            <th>Type peuplement</th>
            <th>Origine</th>
            <th>Type dégâts</th>
          </tr>
        </thead>

        <tbody>

          {%- for declaration in declarations %}

          {%- if session.current_user %}
          {%- set cond_modifier_effacer = (session.current_user.id_droit_max >= 4) or (session.current_user.id_role == declaration.id_declarant) %}
          {%- else %}
          {%- set cond_modifier_effacer = false %}
          {%- endif %}

          <tr>
            <td>
              <i class="btn-action" onclick="M.set_tab_declaration({{ declaration['id_declaration'] }});" title="Voir les détails de la déclaration" data-toggle="tooltip">
                <span class="fas fa-eye"></span>
              </i>

              {%- if cond_modifier_effacer %}
              <a class="btn-action" target="_blank" href="{{ url_for('declaration.modifier_declaration', id_declaration=declaration['id_declaration'])}}" title="Modifier la déclaration" data-toggle="tooltip">
                <span class="fas fa-pen"></span>
              </a>
              {%- endif %}
            </td>
            <td>{{ declaration['id_declaration'] }}</td>
            <td>{{ declaration['declarant'] }}</td>
            <td>{{ declaration['organisme']}}</td>
            <td>{{utils.print_date(declaration['date'])}}</td>
            <td><span data-toggle="tooltip" title="{{declaration['label_foret']}}">{{declaration['label_foret']}}</span></td>
            <td>{{ macros_display.tooltip_areas('OEASC_COMMUNE', declaration["areas_foret"]) }}</td>
            <td>
              {{ macros_display.tooltip_areas('OEASC_CADASTRE', declaration["areas_localisation"]) }}
              {{ macros_display.tooltip_areas('OEASC_ONF_PRF', declaration["areas_localisation"]) }}
            </td>
            <td>
              <b>{{ macros_display.tooltip_mnemonique(declaration.id_nomenclature_peuplement_essence_principale) }}</b>
              {{macros_display.tooltip_mnemonique(declaration.nomenclatures_peuplement_essence_secondaire)}}
            </td>
            <td>{{macros_display.tooltip_mnemonique(declaration.id_nomenclature_peuplement_type)}}</td>
            <td>{{macros_display.tooltip_mnemonique(declaration.id_nomenclature_peuplement_origine)}}</td>
            <td>{{macros_display.tooltip_mnemonique(declaration.nomenclatures_degat_type)}}</td>
          </tr>
          {%- endfor %}
        </tbody>
      </table>
    </div>

    <div id="show_declarations"  class="col-md-6">
      <div id="map_show_declarations" class="map leaftlet-map"></div>
      <div id="chargement">
        <div>Chargement en cours <span class="fa fa-spinner"></span></div>
      </div>
    </div>
  </div>

</div>
</div>
{%- endblock %}

