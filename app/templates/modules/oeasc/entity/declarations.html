{%- block declarations %}

{%- import "modules/oeasc/macros/macros_display.html" as macros_display %}

<div id="declarations">

  <h2>Liste de déclarations</h2>

  <div id="data_declarations">

    {%- for declaration in declarations %}
    <div class="data-declaration" data-declaration='{{ declaration | tojson if declaration else "" }}' style="display:none;"></div>
    {%- endfor %}

  </div>
  {% if session.current_user.id_droit_max >= 5 %}
  <div>

    <div>
<!-- Button trigger modal -->
      <button type="button" class="btn btn-primary" data-toggle="modal" data-target="#exampleModal">
        Exporter les données
      </button>

      <!-- Modal -->
      <div class="modal fade" id="exampleModal" tabindex="-1" role="dialog" aria-labelledby="modalExport" aria-hidden="true">
        <div class="modal-dialog" role="document">
          <div class="modal-content">
            <div class="modal-header">
              <h5 class="modal-title" id="modalExport">Exporter les données</h5>
              <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                <span aria-hidden="true">&times;</span>
              </button>
            </div>
            <div class="modal-body">
              <a class="btn btn-success" href="/api/declaration/declarations_csv">Export CSV <i>une ligne par déclaration</i></a>
              <hr>
              <a class="btn btn-success" href="/api/declaration/declarations_csv?type_out=degat">Export CSV <i>une ligne par dégât</i></a>
              <hr><hr>
              <a class="btn btn-success" href="/api/declaration/declarations_shape">Export SHAPE <i>une ligne par déclaration</i></a>
              <hr>
              <a class="btn btn-success" href="/api/declaration/declarations_shape?type_out=degat">Export SHAPE <i>une ligne par dégât</i></a>
              </div>
            </div>
          </div>
        </div>

      </div>
    </div>
  {% endif %}

  <nav id="declarations_tabs" class="nav nav-tabs">
    <a class="nav-item nav-link" href="#resultats" data-toggle="tab" data-type="T">Tableau</a>
    <a class="nav-item nav-link" href="#resultats" data-toggle="tab" data-type="TC">Carte</a>
  </nav>

  <div class="tab-pane active" id="resultats">

    <div class="row">

      <div id='tableau_declarations' class="col-md-6">
       <table id="table_declarations" class="table-striped table-small">
        <thead>
          <tr>
            <th>Act.</th>
            <th>ID</th>
            <th>Déclarant</th>
            <th>Organisme</th>
            <th>Date</th>
            <th>Nom forêt</th>
            <th>Commune(s)</th>
            <th>Parcelle(s)</th>
            <th>Ess. objectif</th>
            <th>Type peuplement</th>
            <th>Origine</th>
            <th>Type dégâts</th>
          </tr>
        </thead>

        <tbody>

          {%- for declaration in declarations %}

          {%- if session.current_user %}
          {%- set cond_modifier_effacer = (session.current_user.id_droit_max >= 4) or (session.current_user.id_role == declaration.id_declarant) %}
          {%- else %}
          {%- set cond_modifier_effacer = false %}
          {%- endif %}

          <tr>

            <td>
              <i class="btn-action" onclick="M.set_tab_declaration({{ declaration['id_declaration'] }});" title="Voir les détails de la déclaration" data-toggle="tooltip">
                <span class="fas fa-eye"></span>
              </i>
              {%- if cond_modifier_effacer %}
              <a class="btn-action" target="_blank" href="{{ url_for('declaration.modifier_declaration', id_declaration=declaration['id_declaration'])}}" title="Modifier la déclaration" data-toggle="tooltip">
                <span class="fas fa-pen"></span>
              </a>
              {%- endif %}
            </td>
            <td>{{ declaration['id_declaration'] }}</td>
            <td>{{ declaration['declarant'] }}</td>
            <td>{{ declaration['organisme']}}</td>
            <td>{{declaration['declaration_date']}}</td>
            <!-- <td data-sort='<%= my_date.strftime("%d%m%Y") %>'>{{declaration['declaration_date']}}</td> -->
            <td><span data-toggle="tooltip" title="{{declaration['label_foret']}}">{{declaration['label_foret']}}</span></td>
            <td><span data-toggle="tooltip" title="{{declaration['communes']}}">{{declaration['communes']}}</span></td>
            <td><span data-toggle="tooltip" title="{{declaration['parcelles']}}">{{declaration['parcelles']}}</span></td>

            <td>
              <span 
                data-toggle="tooltip"
                title="{{ declaration['peuplement_ess_1_label'] + " " + declaration['peuplement_ess_2_label'] 
                if declaration['peuplement_ess_2_label'] else declaration['peuplement_ess_1_label'] }}">
                <b>{{declaration['peuplement_ess_1_mnemo']}}</b> {{declaration['peuplement_ess_2_mnemo'] if declaration['peuplement_ess_2_mnemo']}}
              </span> 
             
            </td>
            <td><span data-toggle="tooltip" title="{{declaration.peuplement_type_label}}">{{declaration.peuplement_type_mnemo}}</span></td>
            <td><span data-toggle="tooltip" title="{{declaration.peuplement_origine_label}}">{{declaration.peuplement_origine_mnemo}}</span></td>
            <td><span data-toggle="tooltip" title="{{declaration.degat_types_label}}">{{declaration.degat_types_mnemo}}</span></td>

            </tr>
            {%- endfor %}
          </tbody>
        </table>
      </div>
      
      <div id="show_declarations"  class="col-md-6">
        <div id="map_show_declarations" class="map leaftlet-map"></div>
        <div id="chargement">
          <div>Chargement en cours <span class="fa fa-spinner"></span></div>
        </div>
      </div>
    </div>

</div>
</div>
{%- endblock %}

