{%- extends "modules/oeasc/site/layout.html" %}


{%- block title %}Login{%- endblock %}

{%- block content %}

<div class="row">

    <div class="col-md-12">

        <div class="container">
            <h2>Changement du mot de passe</h2>

            <div class="alert alert-danger" role="alert" id="login-error" style="display: none;"></div>

            <div id="email_success" style="display: none;">

                <p>Un email vous a été envoyé sur votre adresse mail.</p>
                <p>Veuillez cliquer sur le lien de présent dans cet email afin de pouvoir modifier votre mot de passe.</p>

            </div>

            <div id="password_success" style="display: none;">

                <p>Votre mot de passe à été modifié. Vous pouvez vous connecter sur la page de 
                {% set href=url_for('oeasc.login')%}
                <button class='btn btn-info' onclick="location.href='{{href}}'">connexion</button>
            </p>

            </div>


            <div id="erreur" style="display: none;" class=red></div>

            {%- if not token %}
            <form class="form-horizontal" id="form_identifiant">


                <div>
                    <div class="form">


                        <p>Entrez votre identifiant (email utilisé pour la création du compte) et appuyez sur <b>modifier le mot de passe</b>.</p>
                        <div id="email">

                            <div class="form-group">
                                <label for="user_id">Email <span data-toggle="tooltip" title="L'identifiant correspond à l'email utilisé pour l'inscription." class="fas fa-question-circle"></span>:</label>
                                <input required type="text" class="form-control" id="form_email" value={{identifiant}}>
                            </div>
                        </div>

                        <button class="btn btn-success">Modifier le mot de passe</button>
                    </div>
                </div>
            </form>

            {%- else %}
            <form class="form-horizontal" id="form_password">


                <div>
                    <div class="form">

                        <div id="pwds">

                            <div class="form-group">
                                <label for="pwd">Mot de passe : </label>
                                <input type="password" class="form-control" id="user_pwd" required>
                            </div>

                            <div class="form-group">
                                <label for="pwd">Confirmation du mot de passe : </label>
                                <input type="password" class="form-control" id="user_pwd_conf" required>
                            </div>
                        </div>
                        <button class="btn btn-success">Modifier le mot de passe</button>


                    </div>
                </div>


            </form>
            {%- endif %}

        </div>

    </div>

</div>

{%- endblock %}


{%- block js_local %}

{{ super() }}

<script>

    $(document).ready(function() {

        "use scrict";


        $("#erreur").hide();

        $("#form_identifiant").submit(function(e) {

            $("#erreur").hide();

            console.log("aaaa")

            e.preventDefault()

            $.post({

                url: '/api/user/reset_password_send_mail',
                data: JSON.stringify({
                    email: $('#form_email').val()
                }),
                contentType:"application/json; charset=utf-8",
                dataType:"json",
            }).done(function(response) {
                console.log('success');
                $('#form_identifiant').hide();
                $('#email_success').show()
            }).
            fail(function(data) {
                console.log("fail")
                $('#erreur').html("erreur : " + data);
                $('#erreur').show()

            });
            console.log("end");
        });

        $("#form_password").submit(function(e) {

            $('#erreur').hide()

            e.preventDefault()

            if($('#user_pwd').val() != $('#user_pwd_conf').val()) {

                $('#erreur').html("Les mot de passe renseignés ne sont pas identiques.");
                $('#erreur').show()

                return False;

            }

            $.post({

                url: '/api/user/reset_password',
                data: JSON.stringify({
                    password: $('#user_pwd').val(),
                    password_confirmation: $('#user_pwd_conf').val(),
                    token: "{{token}}",
                }),
                contentType:"application/json; charset=utf-8",
                dataType:"json",
                success: function(response) {

                    $('#form_password').hide();
                    $('#password_success').show()
                },
                error: function(data) {

                    $('#erreur').html(data);
                    $('#erreur').show()

                },
            })
        });


    });

</script>

{%- endblock %}
