{%- set degats = declaration["degats"] %}
{%- set ns = namespace() %}
{%- set ns.input_disabled = "" %}


<form id="form_degats">

  <h4>Caractérisation des dégâts</h4>


<p><i>Sélectionnez les types de dégâts constatés et pour chacun d’eux, renseignez les informations requises.</i></p>
  <div>
  <!-- <div class="center"> -->
    
  <div id="NOMENCLATURE_DEGAT_TYPE" class="checkbox-group-required form-group" style="display: block;">

    <label for="nomenclatures_degat_type"><b>Type de dégât</b><span class="rouge">{{ "*" if required!="" else "" }}</span></label>

    {%- for elem in nomenclature.OEASC_DEGAT_TYPE['values'] %}

    {%- set ns.checked = "" %}
    {%- set ns.ind = -1 %}

    {%- for degat in degats %}
    {%- if elem.id_nomenclature|string == degat.id_nomenclature_degat_type.id_nomenclature|string %}
    {%- set ns.checked="checked" %}
    {%- set ns.ind=loop.index0 %}
    {%- endif %}
    {%- endfor %}


    <div class="custom-control">

      {%- if ns.ind == -1 %}
      {%- set ns.id_degat = "" %}
      {%- else %}
      {%- set ns.id_degat = "degats[ns.ind].id_degat" %}
      {%- endif %}

      {%- if ns.ind != -1 %}


      {%- set degat = degats[ns.ind] %}
      {%- set mnemonique_degat_type = degat["id_nomenclature_degat_type"].mnemonique %}
      {%- endif %}


{#
       <input id="nomenclatures_degat_type-{{ loop.index0 }}" name="nomenclatures_degat_type" type="checkbox" value="{{ elem.id_nomenclature }}" {{ns.checked}} data-id-degat="{{ns.id_degat}}" >
      <label for="nomenclatures_degat_type-{{ loop.index0 }}">{{ elem.label_fr }}</label>
 #}

      <input id="nomenclatures_degat_type-{{ elem.mnemonique }}" name="nomenclatures_degat_type" type="checkbox" value="{{ elem.id_nomenclature }}" {{ns.checked}} data-id-degat="{{ns.id_degat}}" >
      <label for="nomenclatures_degat_type-{{ elem.mnemonique }}">{{ elem.label_fr }}</label>

      {%- if ns.ind != -1 and mnemonique_degat_type != "P/C" %}
      {%- set degat = degats[ns.ind] %}

      <div class="degat-essence custom-control"  class="dg">

        <div><label for="id_nomenclature_degat_essence"><i class="dg">Essence - (3 essences maximum)</i></label></div>
        {%- if mnemonique_degat_type != "ABS" %}
        <div><label for="id_nomenclature_degat_etendue"><i class="dg">Étendue des dégâts</i></label></div>
        <div><label for="id_nomenclature_degat_gravite"><i class="dg">Gravité des dégâts</i></label></div>
        <div><label for="id_nomenclature_degat_anteriorite"><i class="dg">Antériorité des dégâts</i></label></div>
        {%- else %}
        <div></div>
        <div></div>
        <div></div>
        {%- endif %}
      </div>

      <div class="custom-control degat-essence-container" >

        {%- set selected_essences_locale = [] %}
        {%- set n_degat_essences = (degat["degat_essences"] | length) %}

        {%- if ( n_degat_essences > 0 ) %}

        {%- set degat_essences = degat["degat_essences"] %}

        {%- else %}

        {%- set degat_essences = [{}] %}

        {%- endif %}

        {%- set ns.button_disabled = "" %}

        {%- for degat_essence in degat_essences %}

        {%- if degat_essence["id_nomenclature_degat_essence"]|string != "" and degat_essence["id_nomenclature_degat_essence"] != None %}

        <div class="strayed degat-essence" >
          <div> {{degat_essence.id_nomenclature_degat_essence.label_fr}} </div>
          {%- if mnemonique_degat_type != "ABS" %}
          <div> {{degat_essence.id_nomenclature_degat_etendue.label_fr}} </div>
          <div> {{degat_essence.id_nomenclature_degat_gravite.label_fr}} </div>
          <div> {{degat_essence.id_nomenclature_degat_anteriorite.label_fr}} </div>
          {%- else %}
          <div></div>
          <div></div>
          <div></div>
          {%- endif %}
          <div>
            <button type="button" class="button-modifier-degat-essence btn btn-primary"><span class="fas fa-pen"></span></button>
            <button type="button" class="button-supprimer-degat-essence btn btn-danger" data-degat-type="{{ elem.id_nomenclature }}" data-degat-essence='{{ degat_essence["id_nomenclature_degat_essence"] | tojson if degat_essence["id_nomenclature_degat_essence"] else ""}}'><span class="fas fa-times"></span></button>
          </div>
        </div>

        {%- set ns.display_form='none' %}

        {%- else %}

        {%- set ns.display_form='block' %}
        {%- set ns.input_disabled = "disabled" %}

        {%- endif %}

        <div class="form-degat-essence" data-degat-type="{{ elem.id_nomenclature }}" data-id-degat-essence="{{degat_essence.id_degat_essence}}" style="display: {{ns.display_form}}">

          {%- set add = "_" + elem.id_nomenclature|string + "_" + loop.index0|string %}

          <div class="red degat-essence" >
            {%- if mnemonique_degat_type != "ABS" %}
            Indiquez les essences touchées, et pour chacune d’elle, l’étendue, la gravité et l’antériorité des dégâts, puis validez.
            {%- else %}
            Indiquez les essences concernées.
            {%- endif %}
          </div>

          <div class="degat-essence">

            <div>{{ macros.select_essence("id_nomenclature_degat_essence", nomenclature, object=degat_essence, listes_essences=listes_essences, id_nomenclature_degat_type=degat.id_nomenclature_degat_type.id_nomenclature, required="required") }}</div>

            {%- if mnemonique_degat_type != "ABS" %}

            <div>{{ macros.radio_nomenclature("id_nomenclature_degat_etendue", nomenclature, "OEASC_DEGAT_ETENDUE", "radio", object=degat_essence, add=add) }}</div>
            <div>{{ macros.radio_nomenclature("id_nomenclature_degat_gravite", nomenclature, "OEASC_DEGAT_GRAVITE", "radio", object=degat_essence, add=add) }}</div>
            <div>{{ macros.radio_nomenclature("id_nomenclature_degat_anteriorite", nomenclature, "OEASC_DEGAT_ANTERIORITE", "radio", object=degat_essence, add=add) }}</div>

            {%- else %}

            <div></div>
            <div></div>
            <div></div>

            {%- endif %}

            <div>

              {%- if n_degat_essences > 0 and degat_essence["id_nomenclature_degat_essence"]%}

              {# {{degat["degat_essences"]}} #}

              <button type="button" class="button-undo-degat-essence btn btn-warning" data-degat-type="{{ elem.id_nomenclature }}" data-degat-essence='{{ degat_essence["id_nomenclature_degat_essence"] }}'><span class="fas fa-undo"></span></button>

              {%- endif %}

              <button class="button-valider-degat-essence btn btn-success" data-degat-type="{{ elem.id_nomenclature }}" data-degat-essence='{{ degat_essence["id_nomenclature_degat_essence"] }}'><span class="fas fa-check"></span></button>

            </div>
          </div>



        </div>

        {%- endfor %}

        {%- set ns.button_hidden = "" %}

        {%- if ( n_degat_essences >= 3 ) or ( ns.display_form == 'block' ) or ( ( listes_essences["degats"][degat.id_nomenclature_degat_type.id_nomenclature] | length ) == 0 ) %}

        {%- set ns.button_disabled = "disabled" %}
        {%- set ns.button_hidden = "hidden" %}

        {%- endif %}

        <button type="button"  {{ ns.button_hidden }} {{ ns.button_disabled }} class="button-ajouter-degat-essence btn btn-success" data-degat-type="{{ elem.id_nomenclature }}"><span class="fas fa-plus"></span>{{ " Ajouter une essence touchée"}}</button>

      </div>

      {%- endif %}

    </div>

    {%- endfor %}

  </div>
  </div>

  <div class=blue>

    <p>Des illustrations complémentaires des différents types de dégâts  sont  fournis  dans l'extrait du Guide pratique d'évaluation des dégâts en milieu forestier (CEMAGREF, 2009), <a href="{{ url_for('static', filename='documents/extrait_CEMAGREF.pdf') }}" target="#_blank">cliquez ici</a>.</p>

  </div>

  <div id=degat_types>

  </div>

  <div><p><i><span class="rouge">*</span> Obligatoire.</i></p></div>

<div class="align-right">
  <input {{ ns.input_disabled }} id="input_degat_essence" type=submit value=Suivant class="btn btn-success" title="{{'Veuillez valider les dégats avant de passer à la suite' if ns.input_disabled!='' else ''}}">
</div>

</form>
