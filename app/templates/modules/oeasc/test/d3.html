{%- import "modules/oeasc/form/form_macros.html" as macros %}


{%- extends "modules/oeasc/layout.html" %}


{%- block title %}test d3{%- endblock %}


{%- block content %}

<style>

div.tooltip { 
  position: absolute;     
  text-align: center;     
  /* min-width: 60px;           */
  /* height: 28px;          */
  padding: 10px;       
  font: 12px sans-serif;    
  background: lightsteelblue; 
  border: 0px;    
  border-radius: 8px;     
  pointer-events: none;     
}

</style>

<svg class="chart"></svg>

{%- endblock %}


{%- block js_local %}

{{ super() }}

<script src="http://d3js.org/d3.v4.min.js"></script>

<script>

  var init_bar_chart = function(response) {

    var data = response.data;

    var nb_alertes = response.nb_alertes;

    console.log(nb_alertes, response)

    var width = 1000;

    var margin = ({top: 70, right: 70, bottom: 100, left: 70})

    var height = data.length * 25 + margin.top + margin.bottom


    x = d3.scaleLinear()
    .domain([0, d3.max(data, d => d.value)])
    .range([margin.left, width - margin.right])


    x2 = d3.scaleLinear()
    .domain([0, d3.max(data, d => d.value)/nb_alertes])
    .range([margin.left, width - margin.right])


    y = d3.scaleBand()
    .domain(data.map(d => d.name))
    .range([margin.top, height - margin.bottom])
    .padding(0.1)

    var yAxis = g => g
    .attr("transform", `translate(${margin.left},0)`)
    .call(d3.axisLeft(y).tickSizeOuter(0))

    var xAxis = g => g
    .attr("transform", `translate(0,${margin.top})`)
    .call(d3.axisTop(x).ticks(width / 80))
    .call(g => g.select(".domain").remove());

    format2 = d3.format(".1f");


    var xAxis2 = g => g
    .attr("transform", `translate(0, ${height - margin.bottom})`)
    .call(d3.axisBottom(x2).ticks(width / 80).tickFormat(d3.format(".0%")))
    .call(g => g.select(".domain").remove())


    format = d3.format(".0f");

    var div = d3.select("body").append("div")
    .attr("class", "tooltip")
    .style("opacity", 0);


    const svg = d3.select('.chart');

    svg.style('background-color', 'lightgray')

    svg.append("g")
    .attr("fill", "steelblue")
    .selectAll("rect")
    .data(data)
    .enter().append("rect")
    .attr("x", x(0))
    .attr("y", d => y(d.name))

    .attr("width", 0).
    transition().duration(1000).delay(function(d,i){return (100*i);})
    .attr("width", d => x(d.value) - x(0))
    .attr("height", y.bandwidth());

    svg.append("g")
    .attr("fill", "white")
    .attr("text-anchor", "end")
    .style("font", "12px sans-serif")
    .selectAll("text")
    .data(data)
    .enter().append("text")
    .attr("x", d => x(d.value) - 4)
    .attr("y", d => y(d.name) + y.bandwidth() / 2)
    .attr("dy", "0.35em")
    .text(d => format(d.value));

    svg.append("g")
    .call(xAxis);

    svg.append("g")
    .call(xAxis2);


    svg.append("g")
    .attr("class", "y axis")
    .call(yAxis);

    svg
        .append("text")
        .attr('fill', 'black')
        .attr("x", (width / 2))
        .attr("y", height - 30)
        .attr("text-anchor", "middle")
        .style("font-size", "18px")
        .style("text-decoration", "underline")
        .text("Répartion des différents types de dégâts");

      // text label for the y axis
  svg.append("text")
        .style("font-size", "12px")
      .attr("transform", "rotate(-90)")
      .attr("y", 10 )
      .attr("x",0 - (height / 2))
      .attr("dy", "1em")
      .style("text-anchor", "middle")
      .text("Type de dégât"); 

  // text label for the x axis
  svg.append("text")
        .style("font-size", "12px")
      .attr("transform",
            "translate(" + (width/2) + " ," + 
                           (height - margin.bottom + 40) + ")")
      .style("text-anchor", "middle")
      .text("Pourcentage");


  // text label for the x axis
  svg.append("text")
        .style("font-size", "12px")

      .attr("transform",
            "translate(" + (width/2) + " ," + 
                           (margin.top -30) + ")")
      .style("text-anchor", "middle")
      .text("Nombre (pour un total de " + nb_alertes + " alertes)");


    svg.style('height',height + 'px')
    svg.style('width',width + 'px')

    d3.selectAll('.y .tick text').on('mouseover',function(){

      name = $(this).html();
      label = data.filter(d => d.name == name)[0].label
      position = $(this).offset();
      console.log("aa",label);

      // position.left += 20;
      position.top -= 40;

      $(this).attr('fill', 'red');
      $("div.tooltip").css(position);
      $("div.tooltip").html(label);
      div.transition().duration(500).style("opacity", 0.9);
    });
    d3.selectAll('.y .tick text').on('mouseout',function(){
      div.transition().duration(500).style("opacity", 0);
      $(this).attr('fill', 'black');


    });

  }

  $.ajax('/api/test/get_declarations')
  .done(function(response){

    console.log(response);
    declarations = response


    dict_data = {}
    nb_alertes = declarations.length;

    declarations.forEach(function(declaration){

      origine_peuplement = declaration['id_nomenclature_peuplement_origine']
      origine_peuplement_name = declaration['id_nomenclature_peuplement_origine']['mnemonique']


      degats = declaration['degats']

      degats.forEach(function(degat){

        degat_type = degat['id_nomenclature_degat_type']
        name = degat['id_nomenclature_degat_type']['mnemonique']
        label = degat['id_nomenclature_degat_type']['label_fr']

        if (! dict_data[name]) {

          dict_data[name] = {'name' : name, 'label':label, value: 0, 'values_origin': {}}

        }


        if ( ! dict_data[name]['values_origin'][origine_peuplement_name]) {

          dict_data[name]['values_origin'][origine_peuplement_name] = 0

        }

        dict_data[name]['value'] += 1;
        dict_data[name]['values_origin'][origine_peuplement_name] += 1

      });

    });

    console.log(dict_data);

    data = []

    for( key in dict_data) {

      data.push(dict_data[key])

    }

    // data.sort((a, b) => b.value - a. value);
    data.sort((a, b) => a.value - b. value);

    console.log(data)

    init_bar_chart({'data': data, 'nb_alertes': nb_alertes});

  });




</script>

{%- endblock %}
